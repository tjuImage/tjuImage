<!DOCTYPE html>
<meta charset="utf-8">
<style type="text/css">

svg {
  font-family: "Helvetica Neue", Helvetica;
}

.line {
  fill: none;
  stroke: #000;
  stroke-width: 2px;
}

</style>
<body>
<script src="d3.js"></script>
<script>




function sleep(d){
  for(var t = Date.now();Date.now() - t <= d;);
}
function createXMLHttpRequest() {
  var xmlHttp;
  if (window.XMLHttpRequest) {
    xmlHttp = new XMLHttpRequest();
    if (xmlHttp.overrideMimeType)
      xmlHttp.overrideMimeType('text/xml');
  } else if (window.ActiveXObject) {
    try {
      xmlHttp = new ActiveXObject("Msxml2.XMLHTTP");
    } catch (e) {
      try {
        xmlHttp = new ActiveXObject("Microsoft.XMLHTTP");
      } catch (e) {
      }
    }
  }
  return xmlHttp;
}

var delayGet=4500; //1 秒

function try456(){
setTimeout(function(){
    // xmlHttp = createXMLHttpRequest();
    // var a = Math.random();
    // var url = "http://localhost/vis/jsontry.json?"+a;
    // xmlHttp.open("GET", url, true);// 异步处理返回 
    // xmlHttp.onreadystatechange = try123; 
    // xmlHttp.setRequestHeader("Content-Type",
    //         "application/x-www-form-urlencoded;");
    // xmlHttp.send();
    try123();
    try456();
}, delayGet); 
}

try456();



function try123(){



var m = [20, 20, 30, 20],
    w = 960 - m[1] - m[3],
    h = 500 - m[0] - m[2];

var x,
    y,
    duration = 1500,
    delay = 500;

var color = d3.scale.category10();

var svg = d3.select("body").append("svg")
    .attr("width", w + m[1] + m[3])
    .attr("height", h + m[0] + m[2])
  .append("g")
    .attr("transform", "translate(" + m[3] + "," + m[0] + ")");

var stocks,
    symbols,
    dataArray;

// A line generator, for the dark stroke.
var line = d3.svg.line()
    .interpolate("basis")
    .x(function(d) { return x(d.date); })
    .y(function(d) { return y(d.price); });

// A line generator, for the dark stroke.
var axis = d3.svg.line()
    .interpolate("basis")
    .x(function(d) { return x(d.date); })
    .y(h);

// A area generator, for the dark stroke.
var area = d3.svg.area()
    .interpolate("basis")
    .x(function(d) { return x(d.date); })
    .y1(function(d) { return y(d.price); });

// d3.csv("stocks.csv", function(data) {
  // var parse = d3.time.format("%b %Y").parse;

  // // Nest stock values by symbol.
  // symbols = d3.nest()
  //     .key(function(d) { return d.symbol; })
  //     .entries(stocks = data);
  // console.log(symbols);
  // // Parse dates and numbers. We assume values are sorted by date.
  // // Also compute the maximum price per symbol, needed for the y-domain.
  // symbols.forEach(function(s) {
  //   s.values.forEach(function(d) { d.date = parse(d.date); d.price = +d.price; });
  //   s.maxPrice = d3.max(s.values, function(d) { return d.price; });
  //   s.sumPrice = d3.sum(s.values, function(d) { return d.price; });
  // });

  // // Sort by maximum price, descending.
  // symbols.sort(function(a, b) { return b.maxPrice - a.maxPrice; });

var a = Math.random();
d3.csv("http://localhost/vis/image_data0-2?"+a,function(data){

  

   dataArray = [];
  var dataLength = data.length > 50 ? 50 : dataLength;
  var maxArray = [0,0,0,0,0,0,0,0];
  var minArray = [0,0,0,0,0,0,0,0];

  //转换成Date格式
  for (var i = 0; i < data.length; ++i) {
    data[i].date = new Date(data[i].date);
  }

  //按照Date来升序排列
  data.sort(function(a,b){ return a.date - b.date;});

  for (var i = data.length - dataLength; i < data.length; ++i) {
    //找到最大的值
    maxArray[0] = maxArray[0] > parseFloat(data[i].Anger) ? maxArray[0] : parseFloat(data[i].Anger);
    maxArray[1] = maxArray[1] > parseFloat(data[i].Contempt) ? maxArray[1] : parseFloat(data[i].Contempt);
    maxArray[2] = maxArray[2] > parseFloat(data[i].Disgust) ? maxArray[2] : parseFloat(data[i].Disgust);
    maxArray[3] = maxArray[3] > parseFloat(data[i].Fear) ? maxArray[3] : parseFloat(data[i].Fear);
    maxArray[4] = maxArray[4] > parseFloat(data[i].Sadness) ? maxArray[4] : parseFloat(data[i].Sadness);
    maxArray[5] = maxArray[5] > parseFloat(data[i].Neutral) ? maxArray[5] : parseFloat(data[i].Neutral);
    maxArray[6] = maxArray[6] > parseFloat(data[i].Happiness) ? maxArray[6] : parseFloat(data[i].Happiness);
    maxArray[7] = maxArray[7] > parseFloat(data[i].Surprise) ? maxArray[7] : parseFloat(data[i].Surprise);

  //  //找到最小的值
  //  minArray[0] = minArray[0] < parseFloat(data[i].Anger) ? minArray[0] : parseFloat(data[i].Anger);
  //  minArray[1] = minArray[1] < parseFloat(data[i].Contempt) ? minArray[1] : parseFloat(data[i].Contempt);
  //  minArray[2] = minArray[2] < parseFloat(data[i].Disgust) ? minArray[2] : parseFloat(data[i].Disgust);
  //  minArray[3] = minArray[3] < parseFloat(data[i].Fear) ? minArray[3] : parseFloat(data[i].Fear);
  //  minArray[4] = minArray[4] < parseFloat(data[i].Sadness) ? minArray[4] : parseFloat(data[i].Sadness);
  //  minArray[5] = minArray[5] < parseFloat(data[i].Neutral) ? minArray[5] : parseFloat(data[i].Neutral);
  //  minArray[6] = minArray[6] < parseFloat(data[i].Happiness) ? minArray[6] : parseFloat(data[i].Happiness);
  //  minArray[7] = minArray[7] < parseFloat(data[i].Surprise) ? minArray[7] : parseFloat(data[i].Surprise);
  }
  
  dataArray[0] = {key : "Anger", maxPrice : maxArray[0], values : []};
  dataArray[1] = {key : "Contempt", maxPrice : maxArray[1], values : []};
  dataArray[2] = {key : "Disgust", maxPrice : maxArray[2], values : []};
  dataArray[3] = {key : "Fear", maxPrice : maxArray[3], values : []};
  dataArray[4] = {key : "Sadness", maxPrice : maxArray[4], values : []};
  dataArray[5] = {key : "Neutral", maxPrice : maxArray[5], values : []};
  dataArray[6] = {key : "Happiness", maxPrice : maxArray[6], values : []};
  dataArray[7] = {key : "Surprise", maxPrice : maxArray[7], values : []};

  var start = data.length - dataLength;
  for (var i = data.length - dataLength; i < data.length; ++i) {
    dataArray[0].values[i - start] = {date : data[i].date, price : data[i].Anger};
    dataArray[1].values[i - start] = {date : data[i].date, price : data[i].Contempt};
    dataArray[2].values[i - start] = {date : data[i].date, price : data[i].Disgust};
    dataArray[3].values[i - start] = {date : data[i].date, price : data[i].Fear};
    dataArray[4].values[i - start] = {date : data[i].date, price : data[i].Sadness};
    dataArray[5].values[i - start] = {date : data[i].date, price : data[i].Neutral};
    dataArray[6].values[i - start] = {date : data[i].date, price : data[i].Happiness};
    dataArray[7].values[i - start] = {date : data[i].date, price : data[i].Surprise};
  }
 
  var g = svg.selectAll("g")
      .data(dataArray)
      .enter().append("g")
      .attr("class", "dataArray");

  setTimeout(lines, duration);
});

function lines() {
  x = d3.time.scale().range([0, w - 60]);
  y = d3.scale.linear().range([h / 8 - 20, 0]);
  console.log(dataArray);
  // Compute the minimum and maximum date across symbols.
  x.domain([
    d3.min(dataArray, function(d) { return d.values[0].date; }),
    d3.max(dataArray, function(d) { return d.values[d.values.length - 1].date; })
  ]);

  var g = svg.selectAll(".dataArray")
      .attr("transform", function(d, i) { return "translate(0," + (i * h / 8 + 10) + ")"; });

  g.each(function(d) {
    var e = d3.select(this);

    e.append("path")
        .attr("class", "line");

    e.append("circle")
        .attr("r", 5)
        .style("fill", function(d) { return color(d.key); })
        .style("stroke", "#000")
        .style("stroke-width", "2px");

    e.append("text")
        .attr("x", 12)
        .attr("dy", ".31em")
        .text(d.key);
  });

  function draw(k) {
    g.each(function(d) {
      var e = d3.select(this);
      y.domain([0, d.maxPrice]);

      e.select("path")
          .attr("d", function(d) { return line(d.values.slice(0, k + 1)); });

      e.selectAll("circle, text")
          .data(function(d) { return [d.values[k], d.values[k]]; })
          .attr("transform", function(d) { return "translate(" + x(d.date) + "," + y(d.price) + ")"; });
    });
  }

  var k = 1, n = dataArray[0].values.length;
 // 这个是原来的
  d3.timer(function() {
    draw(k);
    if ((k += 2) >= n - 1) {
      draw(n - 1);
      setTimeout(horizons, 500);
      return true;
    }
  });

  // //这个是测试
  // d3.timer(function() {
  //   draw(k);
  //   if ((k += 2) >= n - 1) {
  //     draw(n - 1);
  //     setTimeout(function() {
  //   svg.selectAll("*").remove();
  //   svg.selectAll("g").data(dataArray).enter().append("g").attr("class", "dataArray");
  //   lines();
  // }, 500);
  //     return true;
  //   }
  // });

   //这里只是测试的
    // setTimeout(function() {
    // svg.selectAll("*").remove();
    // svg.selectAll("g").data(symbols).enter().append("g").attr("class", "symbol");
    // lines();
  // }, duration);
}

function horizons() {
  svg.insert("defs", ".dataArray")
    .append("clipPath")
      .attr("id", "clip")
    .append("rect")
      .attr("width", w)
      .attr("height", h / 8 - 20);

  var color = d3.scale.ordinal()
      .range(["#c6dbef", "#9ecae1", "#6baed6"]);

  var g = svg.selectAll(".dataArray")
      .attr("clip-path", "url(#clip)");

  area
      .y0(h / 8 - 20);

  g.select("circle").transition()
      .duration(duration)
      .attr("transform", function(d) { return "translate(" + (w - 60) + "," + (-h / 8) + ")"; })
      .remove();

  g.select("text").transition()
      .duration(duration)
      .attr("transform", function(d) { return "translate(" + (w - 60) + "," + (h / 8 - 20) + ")"; })
      .attr("dy", "0em");

  g.each(function(d) {
    y.domain([0, d.maxPrice]);

    d3.select(this).selectAll(".area")
        .data(d3.range(3))
      .enter().insert("path", ".line")
        .attr("class", "area")
        .attr("transform", function(d) { return "translate(0," + (d * (h / 8 - 20)) + ")"; })
        .attr("d", area(d.values))
        .style("fill", function(d, i) { return color(i); })
        .style("fill-opacity", 1e-6);

    y.domain([0, d.maxPrice / 7]);

    d3.select(this).selectAll(".line").transition()
        .duration(duration)
        .attr("d", line(d.values))
        .style("stroke-opacity", 1e-6);

    d3.select(this).selectAll(".area").transition()
        .duration(duration)
        .style("fill-opacity", 1)
        .attr("d", area(d.values))
        .each("end", function() { d3.select(this).style("fill-opacity", null); });
  });
  //这个是原来的
  setTimeout(areas, duration + delay);
  //  // 这里只是测试的
  //   setTimeout(function() {
  //   svg.selectAll("*").remove();
  //   svg.selectAll("g").data(dataArray).enter().append("g").attr("class", "dataArray");
  //   lines();
  // }, duration);
}

function areas() {
  var g = svg.selectAll(".dataArray");

  axis
      .y(h / 8 - 21);

  g.select(".line")
      .attr("d", function(d) { return axis(d.values); });

  g.each(function(d) {
    y.domain([0, d.maxPrice]);

    d3.select(this).select(".line").transition()
        .duration(duration)
        .style("stroke-opacity", 1)
        .each("end", function() { d3.select(this).style("stroke-opacity", null); });

    d3.select(this).selectAll(".area")
        .filter(function(d, i) { return i; })
      .transition()
        .duration(duration)
        .style("fill-opacity", 1e-6)
        .attr("d", area(d.values))
        .remove();

    d3.select(this).selectAll(".area")
        .filter(function(d, i) { return !i; })
      .transition()
        .duration(duration)
        .style("fill", color(d.key))
        .attr("d", area(d.values));
  });

  svg.select("defs").transition()
      .duration(duration)
      .remove();

  g.transition()
      .duration(duration)
      .each("end", function() { d3.select(this).attr("clip-path", null); });
//   //这里是原来的
  // setTimeout(stackedArea, duration + delay);
   // 这里只是测试的
  setTimeout(function() {
      svg.selectAll("*").remove();
      svg.selectAll("g").data(dataArray).enter().append("g").attr("class", "dataArray");
      lines();
    }, duration);
 
}

}
// function stackedArea() {
//   var stack = d3.layout.stack()
//       .values(function(d) { return d.values; })
//       .x(function(d) { return d.date; })
//       .y(function(d) { return d.price; })
//       .out(function(d, y0, y) { d.price0 = y0; })
//       .order("reverse");

//   stack(dataArray);

//   y
//       .domain([0, d3.max(dataArray[0].values.map(function(d) { return d.price + d.price0; }))])
//       .range([h, 0]);

//   line
//       .y(function(d) { return y(d.price0); });

//   area
//       .y0(function(d) { return y(d.price0); })
//       .y1(function(d) { return y(d.price0 + d.price); });

//   var t = svg.selectAll(".dataArray").transition()
//       .duration(duration)
//       .attr("transform", "translate(0,0)")
//       .each("end", function() { d3.select(this).attr("transform", null); });

//   t.select("path.area")
//       .attr("d", function(d) { return area(d.values); });

//   t.select("path.line")
//       .style("stroke-opacity", function(d, i) { return i < 3 ? 1e-6 : 1; })
//       .attr("d", function(d) { return line(d.values); });

//   t.select("text")
//       .attr("transform", function(d) { d = d.values[d.values.length - 1]; return "translate(" + (w - 60) + "," + y(d.price / 2 + d.price0) + ")"; });

//   // setTimeout(streamgraph, duration + delay);

//     setTimeout(function() {
//       svg.selectAll("*").remove();
//       svg.selectAll("g").data(dataArray).enter().append("g").attr("class", "dataArray");
//       lines();
//     }, duration);
// }

// function streamgraph() {
//   var stack = d3.layout.stack()
//       .values(function(d) { return d.values; })
//       .x(function(d) { return d.date; })
//       .y(function(d) { return d.price; })
//       .out(function(d, y0, y) { d.price0 = y0; })
//       .order("reverse")
//       .offset("wiggle");

//   stack(symbols);

//   line
//       .y(function(d) { return y(d.price0); });

//   var t = svg.selectAll(".symbol").transition()
//       .duration(duration);

//   t.select("path.area")
//       .attr("d", function(d) { return area(d.values); });

//   t.select("path.line")
//       .style("stroke-opacity", 1e-6)
//       .attr("d", function(d) { return line(d.values); });

//   t.select("text")
//       .attr("transform", function(d) { d = d.values[d.values.length - 1]; return "translate(" + (w - 60) + "," + y(d.price / 2 + d.price0) + ")"; });

//   setTimeout(overlappingArea, duration + delay);
// }

// function overlappingArea() {
//   var g = svg.selectAll(".symbol");

//   line
//       .y(function(d) { return y(d.price0 + d.price); });

//   g.select(".line")
//       .attr("d", function(d) { return line(d.values); });

//   y
//       .domain([0, d3.max(symbols.map(function(d) { return d.maxPrice; }))])
//       .range([h, 0]);

//   area
//       .y0(h)
//       .y1(function(d) { return y(d.price); });

//   line
//       .y(function(d) { return y(d.price); });

//   var t = g.transition()
//       .duration(duration);

//   t.select(".line")
//       .style("stroke-opacity", 1)
//       .attr("d", function(d) { return line(d.values); });

//   t.select(".area")
//       .style("fill-opacity", .5)
//       .attr("d", function(d) { return area(d.values); });

//   t.select("text")
//       .attr("dy", ".31em")
//       .attr("transform", function(d) { d = d.values[d.values.length - 1]; return "translate(" + (w - 60) + "," + y(d.price) + ")"; });

//   svg.append("line")
//       .attr("class", "line")
//       .attr("x1", 0)
//       .attr("x2", w - 60)
//       .attr("y1", h)
//       .attr("y2", h)
//       .style("stroke-opacity", 1e-6)
//     .transition()
//       .duration(duration)
//       .style("stroke-opacity", 1);

//   setTimeout(groupedBar, duration + delay);
// }

// function groupedBar() {
//   x = d3.scale.ordinal()
//       .domain(symbols[0].values.map(function(d) { return d.date; }))
//       .rangeBands([0, w - 60], .1);

//   var x1 = d3.scale.ordinal()
//       .domain(symbols.map(function(d) { return d.key; }))
//       .rangeBands([0, x.rangeBand()]);

//   var g = svg.selectAll(".symbol");

//   var t = g.transition()
//       .duration(duration);

//   t.select(".line")
//       .style("stroke-opacity", 1e-6)
//       .remove();

//   t.select(".area")
//       .style("fill-opacity", 1e-6)
//       .remove();

//   g.each(function(p, j) {
//     d3.select(this).selectAll("rect")
//         .data(function(d) { return d.values; })
//       .enter().append("rect")
//         .attr("x", function(d) { return x(d.date) + x1(p.key); })
//         .attr("y", function(d) { return y(d.price); })
//         .attr("width", x1.rangeBand())
//         .attr("height", function(d) { return h - y(d.price); })
//         .style("fill", color(p.key))
//         .style("fill-opacity", 1e-6)
//       .transition()
//         .duration(duration)
//         .style("fill-opacity", 1);
//   });

//   setTimeout(stackedBar, duration + delay);
// }

// function stackedBar() {
//   x.rangeRoundBands([0, w - 60], .1);

//   var stack = d3.layout.stack()
//       .values(function(d) { return d.values; })
//       .x(function(d) { return d.date; })
//       .y(function(d) { return d.price; })
//       .out(function(d, y0, y) { d.price0 = y0; })
//       .order("reverse");

//   var g = svg.selectAll(".symbol");

//   stack(symbols);

//   y
//       .domain([0, d3.max(symbols[0].values.map(function(d) { return d.price + d.price0; }))])
//       .range([h, 0]);

//   var t = g.transition()
//       .duration(duration / 2);

//   t.select("text")
//       .delay(symbols[0].values.length * 10)
//       .attr("transform", function(d) { d = d.values[d.values.length - 1]; return "translate(" + (w - 60) + "," + y(d.price / 2 + d.price0) + ")"; });

//   t.selectAll("rect")
//       .delay(function(d, i) { return i * 10; })
//       .attr("y", function(d) { return y(d.price0 + d.price); })
//       .attr("height", function(d) { return h - y(d.price); })
//       .each("end", function() {
//         d3.select(this)
//             .style("stroke", "#fff")
//             .style("stroke-opacity", 1e-6)
//           .transition()
//             .duration(duration / 2)
//             .attr("x", function(d) { return x(d.date); })
//             .attr("width", x.rangeBand())
//             .style("stroke-opacity", 1);
//       });

//   setTimeout(transposeBar, duration + symbols[0].values.length * 10 + delay);
// }

// function transposeBar() {
//   x
//       .domain(symbols.map(function(d) { return d.key; }))
//       .rangeRoundBands([0, w], .2);

//   y
//       .domain([0, d3.max(symbols.map(function(d) { return d3.sum(d.values.map(function(d) { return d.price; })); }))]);

//   var stack = d3.layout.stack()
//       .x(function(d, i) { return i; })
//       .y(function(d) { return d.price; })
//       .out(function(d, y0, y) { d.price0 = y0; });

//   stack(d3.zip.apply(null, symbols.map(function(d) { return d.values; }))); // transpose!

//   var g = svg.selectAll(".symbol");

//   var t = g.transition()
//       .duration(duration / 2);

//   t.selectAll("rect")
//       .delay(function(d, i) { return i * 10; })
//       .attr("y", function(d) { return y(d.price0 + d.price) - 1; })
//       .attr("height", function(d) { return h - y(d.price) + 1; })
//       .attr("x", function(d) { return x(d.symbol); })
//       .attr("width", x.rangeBand())
//       .style("stroke-opacity", 1e-6);

//   t.select("text")
//       .attr("x", 0)
//       .attr("transform", function(d) { return "translate(" + (x(d.key) + x.rangeBand() / 2) + "," + h + ")"; })
//       .attr("dy", "1.31em")
//       .each("end", function() { d3.select(this).attr("x", null).attr("text-anchor", "middle"); });

//   svg.select("line").transition()
//       .duration(duration)
//       .attr("x2", w);

//   setTimeout(donut,  duration / 2 + symbols[0].values.length * 10 + delay);
// }

// function donut() {
//   var g = svg.selectAll(".symbol");

//   g.selectAll("rect").remove();

//   var pie = d3.layout.pie()
//       .value(function(d) { return d.sumPrice; });

//   var arc = d3.svg.arc();

//   g.append("path")
//       .style("fill", function(d) { return color(d.key); })
//       .data(function() { return pie(symbols); })
//     .transition()
//       .duration(duration)
//       .tween("arc", arcTween);

//   g.select("text").transition()
//       .duration(duration)
//       .attr("dy", ".31em");

//   svg.select("line").transition()
//       .duration(duration)
//       .attr("y1", 2 * h)
//       .attr("y2", 2 * h)
//       .remove();

//   function arcTween(d) {
//     var path = d3.select(this),
//         text = d3.select(this.parentNode.appendChild(this.previousSibling)),
//         x0 = x(d.data.key),
//         y0 = h - y(d.data.sumPrice);

//     return function(t) {
//       var r = h / 2 / Math.min(1, t + 1e-3),
//           a = Math.cos(t * Math.PI / 2),
//           xx = (-r + (a) * (x0 + x.rangeBand()) + (1 - a) * (w + h) / 2),
//           yy = ((a) * h + (1 - a) * h / 2),
//           f = {
//             innerRadius: r - x.rangeBand() / (2 - a),
//             outerRadius: r,
//             startAngle: a * (Math.PI / 2 - y0 / r) + (1 - a) * d.startAngle,
//             endAngle: a * (Math.PI / 2) + (1 - a) * d.endAngle
//           };

//       path.attr("transform", "translate(" + xx + "," + yy + ")");
//       path.attr("d", arc(f));
//       text.attr("transform", "translate(" + arc.centroid(f) + ")translate(" + xx + "," + yy + ")rotate(" + ((f.startAngle + f.endAngle) / 2 + 3 * Math.PI / 2) * 180 / Math.PI + ")");
//     };
//   }

//   setTimeout(donutExplode, duration + delay);
// }

// function donutExplode() {
//   var r0a = h / 2 - x.rangeBand() / 2,
//       r1a = h / 2,
//       r0b = 2 * h - x.rangeBand() / 2,
//       r1b = 2 * h,
//       arc = d3.svg.arc();

//   svg.selectAll(".symbol path")
//       .each(transitionExplode);

//   function transitionExplode(d, i) {
//     d.innerRadius = r0a;
//     d.outerRadius = r1a;
//     d3.select(this).transition()
//         .duration(duration / 2)
//         .tween("arc", tweenArc({
//           innerRadius: r0b,
//           outerRadius: r1b
//         }));
//   }

//   function tweenArc(b) {
//     return function(a) {
//       var path = d3.select(this),
//           text = d3.select(this.nextSibling),
//           i = d3.interpolate(a, b);
//       for (var key in b) a[key] = b[key]; // update data
//       return function(t) {
//         var a = i(t);
//         path.attr("d", arc(a));
//         text.attr("transform", "translate(" + arc.centroid(a) + ")translate(" + w / 2 + "," + h / 2 +")rotate(" + ((a.startAngle + a.endAngle) / 2 + 3 * Math.PI / 2) * 180 / Math.PI + ")");
//       };
//     }
//   }

//   setTimeout(function() {
//     svg.selectAll("*").remove();
//     svg.selectAll("g").data(symbols).enter().append("g").attr("class", "symbol");
//     lines();
//   }, duration);
// }

</script>